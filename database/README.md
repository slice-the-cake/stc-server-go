# STC Database

The server uses [PostgreSQL](https://www.postgresql.org/) as the database.

## Migrations

The database migrations are driven by:

- the `migration.sh` script
- the `schema.sql` "source of truth" schema file
- the migrations inside the `migrations` directory, which are auto-generated by [atlas](https://atlasgo.io/) based on the last changes to `schema.sql`

### Requirements

- basic Unix environment
- [podman](https://podman.io/). `migration.sh` can eventually be extended to also support docker

### Usage examples

The following examples assume you're in the root of the repository.

One way to make environment variables available is to prepend them by reading from an `.env` file, like so:

```sh
eval "$(cat .env | xargs)" ./database/migration.sh
```

There's an `.env-sample` file that can be copy/pasted into an `.env` file, which is git-ignored. You can then adjust the `.env` file as required.

Make changes to the `schema.sql` file then create a migration:

```sh
eval "$(cat .env | xargs)" ./database/migration.sh diff <MIGRATION_NAME>
```

Apply migrations to a test Postgres database container:

```sh
eval "$(cat .env | xargs)" ./database/migration.sh apply_test
```

You can connect to Postgres in the container to check if the changes were applied correctly.

Apply migrations to the database which URL is contained in the 'DB_URL' environment variable:

```sh
eval "$(cat .env | xargs)" ./database/migration.sh apply -e DB_URL
```

Apply migrations to the database located in <DB_URL>:

```sh
eval "$(cat .env | xargs)" ./database/migration.sh apply <DB_URL>
```

Stop test Postgres database container:

```sh
./database/migration.sh stop_test
```

